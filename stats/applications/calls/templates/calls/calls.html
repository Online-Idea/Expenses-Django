{% extends 'base/base.html' %}
{% load static %}

{% block headcontent %}

<title>Звонки</title>

{% include 'base/daterange_picker.html' %}

{% endblock %}

{% block content %}
<!--Modal-->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <!-- сюда подставится из edit_modal.html при вызове модального окна -->
    </div>
  </div>
</div>


<div class="container">
  <div class="row">
    <div class="col-xl-12 center">
      <h3 class="logo"><a href="{% url 'calls' %}">Звонки</a></h3>

      <!--Выбор периода-->
      <form method="POST" class="period" action="{% url 'calls' %}">
        {% csrf_token %}
        {{ form.daterange }}
        <button type="submit" class="btn btn-primary">Показать</button>
        <button type="submit" class="btn btn-outline-primary" formaction="{% url 'download_comparison' %}">Скачать
        </button>
        <!--Список клиентов-->
        <details>
          <summary>Клиенты</summary>
          <div class="content">
            <label for="id_select_all_clients">
              {{ form.select_all_clients }}
              Выбрать все
            </label>
            {{ form.client_checkbox }}
          </div>
        </details>
      </form>

        <!--Таблица звонков-->
        <div class="table-responsive">
          <table
            id="datatable_calls"
            width="100%"
            class="table table-striped table-bordered dt-responsive hover"
          >
            <thead class="table-dark"></thead>
          </table>
        </div>

        {% if request.method == 'POST' %}
        <script language="javascript">
          $(document).ready(function () {
            AjaxDatatableViewUtils.initialize_table(
              $("#datatable_calls"),
              "{% url 'ajax_datatable_calls' %}",
              {
                fixedHeader: true,
                responsive: false,
                // full_row_select: true,
                processing: true,
                autoWidth: true,
                scrollX: true,
                language: { url: '{% static "js/datatables-ru.json" %}', },
                pageLength: 50,
              },
              {
                // extra_data
                filter_params: "{{ filter_params }}",
              },
            );

            $('#datatable_calls').on('draw.dt', function () {
              audioButtons('button[data-audio-url]');
            });

          });
        </script>
        {% endif %}

      <!--Аудио плеер-->
      <div id="audio-player">
        <audio id="audio-element" controls></audio>
      </div>

    </div>
  </div>
</div>

<script type="text/javascript" src="{% static 'js/dynamic_fields.js' %}"></script>
<script>
  // Отмечает ранее выбранные чекбоксы
  document.addEventListener("DOMContentLoaded", function() {
    {% if clients_checked %}
      selected_checkboxes({{ clients_checked|safe }}, 'client_checkbox', 'select_all_clients');
    {% endif %}
  });


  // Иконки
  const playClasses = 'fa-regular fa-circle-play';
  const pauseClasses = 'fa-solid fa-pause';
  const replayClasses = 'fa-solid fa-rotate-left';
  // Кнопки звонков и элементы плеера
  const audioElement = document.getElementById('audio-element');
  const audioPlayer = document.getElementById('audio-player');
  // Чтобы менять иконку на последней включенной записи звонка
  let lastPlayedButton, lastPlayedIcon, clonedPlayButton, clonedPlayIcon;

  function audioEvents(element) {
    // Вид и функционал кнопок плеера у звонков внутри таблицы

    let icon = element.querySelector('i');

    // Если иконка play
    if (icon.className === playClasses) {
      // Меняю на иконку pause
      icon.className = pauseClasses;

      // Если src пустой то меняю на ссылку с текущего звонка
      if (audioElement.src === '' ) {
        audioElement.src = element.dataset.audioUrl;
      }

      // Если src не равен текущему звонку значит начали слушать другой звонок, меняю src на ссылку текущего звонка
      // и иконку прошлого звонка на play
      if (audioElement.src !== element.dataset.audioUrl) {
        audioElement.src = element.dataset.audioUrl;
        lastPlayedIcon.className = playClasses;
      }

      // Если не на паузе значит подгружаю запись звонка
      if (!audioElement.paused) {
        audioElement.load();
      }

      // Включаю плеер, показываю его, запоминаю кнопку и иконку звонка который начали слушать
      audioElement.play();
      audioPlayer.style.display = 'block';
      {#lastPlayedButton = element;#}
      if (element !== clonedPlayButton) {
        lastPlayedButton = element;
        lastPlayedIcon = icon;
      } else {
        clonedPlayIcon = icon;
      }

    } else if (icon.className === pauseClasses) {
      // Если иконка pause то ставлю на паузу и меняю иконку на play
      audioElement.pause();
      icon.className = playClasses;

    } else if (icon.className === replayClasses) {
      // Если иконка replay то начинаю с начала и меняю иконку на pause
      audioElement.play();
      icon.className = pauseClasses;
    }
  }

  function audioButtons(selector) {
    // Аудио плеер
    // Меняю иконку последнего звонка в зависимости от состояния плеера
    audioElement.addEventListener('play', () => {
      lastPlayedIcon.className = pauseClasses;
    });
    audioElement.addEventListener('pause', () => {
      lastPlayedIcon.className = playClasses;
    });
    audioElement.addEventListener('ended', () => {
      lastPlayedIcon.className = replayClasses;
      clonedPlayIcon.className = clonedPlayButton ? replayClasses : null;
    });

    // event listener на каждую кнопку звонка
    const playButtons = document.querySelectorAll(selector);
    playButtons.forEach(button => {
      button.addEventListener('click', () => {
        audioEvents(button);
      });
    });
  }

  $(document).ready(function() {
    <!--Чекбокс Выбрать все для клиентов-->
    $('#id_select_all_clients').click(function() {
      $('input[type=checkbox][name=client_checkbox]').prop('checked', $(this).prop('checked'));
    });

    // Modal
    let modal = $('#editModal');

    modal.on('show.bs.modal', function(event) {
      // Наполняю модальное окно данными
      let button = $(event.relatedTarget);
      let id = button.data('id');

      $.ajax({
        url: `/calls/edit/${id}`,
        type: 'GET',
        success: function (response) {
          $('.modal-content').replaceWith(response);
          {#$('#id_mark').on('change', modelFromMark);#}
          modelFromMark();
        },
        error: function (error) {
          console.error(error);
        }
      });
    })

    modal.on('shown.bs.modal', function (event) {
      // Кнопка Обновить модального окна
      $('#save-btn').on('click', function (e) {
        e.preventDefault();
        const id = $('#recordId').val();
        const data = $('#editForm').serialize();

        $.ajax({
          url: `/api/v1/calls/${id}/`,
          type: 'PUT',
          data: data,
          beforeSend: function (xhr) {
            xhr.setRequestHeader('X-CSRFToken', $('input[name=csrfmiddlewaretoken]').val());
          },
          success: function (response) {
            $('#editModal').modal('hide');
          },
          error: function (error) {
            console.log(error);
          }
        }).done(function (data, textStatus, jqXHR) {
          let table = $('#datatable_calls');
          // Вроде не нужно всю таблицу перерисовывать, но пока оставлю
          {#table.DataTable().ajax.reload(null, false); // Reload the table data#}
          // Invalidate and draw the row
          let tr = $(`#row-${id}`);
          let row = table.DataTable().row(tr);
          row.invalidate().draw();
        });
      });

      // Кнопка плеера, клонирую с текущего звонка
      const row = event.relatedTarget.closest('tr');
      lastPlayedButton = row.querySelector('.play-record-btn');
      lastPlayedIcon = lastPlayedButton.querySelector('i');
      clonedPlayButton = lastPlayedButton.cloneNode(true);
      clonedPlayIcon = clonedPlayButton.querySelector('i');
      const modalBody = document.querySelector('.modal-body');
      modalBody.insertBefore(clonedPlayButton, modalBody.firstChild);
      clonedPlayButton.addEventListener('click', event => {
        event.preventDefault();
        audioEvents(clonedPlayButton);
      });
    })


  });
</script>

{% endblock %}
