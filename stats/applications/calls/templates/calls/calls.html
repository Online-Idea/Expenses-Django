{% extends 'base/base.html' %}
{% load static %}

{% block headcontent %}

<title>Звонки</title>

{% include 'base/daterange_picker.html' %}

{% endblock %}

{% block content %}
<!--Modal-->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">Edit Row</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <input type="text" id="edit-note" placeholder="Edit note">

      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="save-btn">Save changes</button>
      </div>

    </div>
  </div>
</div>


<div class="container">
  <div class="row">
    <div class="col-xl-12 center">
      <h3 class="logo"><a href="{% url 'calls' %}">Звонки</a></h3>

      <!--Выбор периода-->
      <form method="POST" class="period">
        {% csrf_token %}
        {{ form.daterange }}
        <button type="submit" class="btn btn-primary">Показать</button>
        <button type="submit" class="btn btn-outline-primary" formaction="{% url 'download_comparison' %}">Скачать
        </button>
        <!--Список клиентов-->
        <details>
          <summary>Клиенты</summary>
          <div class="content">
            <label for="id_select_all_clients">
              {{ form.select_all_clients }}
              Выбрать все
            </label>
            {{ form.client_checkbox }}
          </div>
        </details>
      </form>

        <!--Таблица звонков-->
        <div class="table-responsive">
          <table
            id="datatable_calls"
            width="100%"
            class="table table-striped table-bordered dt-responsive hover"
          >
            <thead class="table-dark"></thead>
          </table>
        </div>

        {% if request.method == 'POST' %}
        <script language="javascript">
          $(document).ready(function () {
            AjaxDatatableViewUtils.initialize_table(
              $("#datatable_calls"),
              "{% url 'ajax_datatable_calls' %}",
              {
                fixedHeader: true,
                responsive: false,
                // full_row_select: true,
                processing: true,
                autoWidth: true,
                scrollX: true,
                language: { url: '{% static "js/datatables-ru.json" %}', },
                pageLength: 50,
              },
              {
                // extra_data
                filter_params: "{{ filter_params }}",
              },
            );
          });
        </script>
        {% endif %}
    </div>
  </div>
</div>

<script>
  // Отмечает ранее выбранные чекбоксы
  document.addEventListener("DOMContentLoaded", function() {
    {% if clients_checked %}
      selected_checkboxes({{ clients_checked|safe }}, 'client_checkbox', 'select_all_clients');
    {% endif %}
  });

  // Modal
  $(document).ready(function() {
    $('#editModal').on('show.bs.modal', function(event) {
      let button = $(event.relatedTarget);
      let id = button.data('id');
      let modal = $(this);
      modal.find('#edit-note').val();
      modal.find('#save-btn').click(function() {
        let note = modal.find('#edit-note').val();
        saveNote(id, note);
      });
    });
  });

  function saveNote(id, note) {
    $.ajax({
      url: '/path/to/save/note',
      type: 'POST',
      data: {
        id: id,
        note: note
      },
      success: function(response) {
        $('#editModal').modal('hide');
      },
      error: function(error) {
        console.error(error);
      }
    });
  }
</script>

{% endblock %}
