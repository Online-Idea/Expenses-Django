{% extends 'statsapp/base.html' %}

{% block content %}
<script>
<!--Выбор периода-->
                $(function() {
                  $('input[name="daterange"]').daterangepicker({
                    opens: 'left',
                    "showDropdowns": true,
                    "minYear": 2016,
                    "maxYear": 2050,
                    "autoApply": true,
                    "locale": {
                        "format": "DD.MM.YYYY",
                        "separator": " - ",
                        "applyLabel": "Apply",
                        "cancelLabel": "Cancel",
                        "fromLabel": "From",
                        "toLabel": "To",
                        "customRangeLabel": "Custom",
                        "weekLabel": "Н",
                        "daysOfWeek": [
                            "Вс",
                            "Пн",
                            "Вт",
                            "Ср",
                            "Чт",
                            "Пт",
                            "Сб"
                        ],
                        "monthNames": [
                            "Январь",
                            "Февраль",
                            "Март",
                            "Апрель",
                            "Май",
                            "Июнь",
                            "Июль",
                            "Август",
                            "Сентябрь",
                            "Октябрь",
                            "Ноябрь",
                            "Декабрь"
                        ],
                        "firstDay": 1,
                    },
                    "startDate": "{{ datefrom }}",
                    "endDate": "{{ dateto }}",
                    "drops": "right"
                },  function(start, end, label) {
                    console.log("A new date selection was made: " + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD'));
                  });
                });
                </script>
<script>
<!--Сортировка таблицы по заголовку-->
<!--https://www.w3schools.com/howto/howto_js_sort_table.asp-->
function sortTable(n) {
  var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
  table = document.getElementById("tableOne");
  switching = true;
  dir = "asc";
  while (switching) {
    switching = false;
    rows = table.rows;
    for (i = 1; i < (rows.length - 2); i++) {
      shouldSwitch = false;
      if (n == 0) {
        x = rows[i].getElementsByTagName("TD")[n].childNodes[2].textContent;
        y = rows[i + 1].getElementsByTagName("TD")[n].childNodes[2].textContent;
      } else {
        x = Number(rows[i].getElementsByTagName("TD")[n].childNodes[2].textContent);
        y = Number(rows[i + 1].getElementsByTagName("TD")[n].childNodes[2].textContent);
      }
      if (dir == "asc") {
        if (x > y) {
          shouldSwitch = true;
          break;
        }
      } else if (dir == "desc") {
        if (x < y) {
          shouldSwitch = true;
          break;
        }
      }
    }
    if (shouldSwitch) {
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
      switching = true;
      switchcount ++;
    } else {
      if (switchcount == 0 && dir == "asc") {
        dir = "desc";
        switching = true;
      }
    }
  }
}
</script>
<div class="container">
    <div class="row">
        <div class="col-xl-12">
            <h3 class="logo"><a href="{% url 'home' %}">Себестоимость звонков</a></h3>
            <p><em>сейчас только авто.ру</em></p>

            <!--Выбор периода-->
            <form method="POST" class="period">
                {% csrf_token %}
                {{ form.daterange }}
                <button type="submit" class="btn btn-primary">Показать</button>
                <!--Список клиентов-->
                <details>
                  <!--Отмечает ранее выбранных клиентов-->
                  {% if clients_checked %}
                    <summary onclick="selected_clients({{ clients_checked }})">Клиенты</summary>
                  {% else %}
                    <summary>Клиенты</summary>
                  {% endif %}
                  <div class="content">
                      <ul>
                          <li><input type="checkbox" onClick="toggle(this)" checked/> Выбрать все</li>
                          {{ form.client_checkbox }}
                      </ul>
                  </div>
                </details>
            </form>

            <!--Таблица себестоимости-->
            {% if stats %}
            <table class="table table-bordered table-striped table-responsive-stack"  id="tableOne">
                <thead class="thead-dark">
                    <tr>
                        <th onclick="sortTable(0)">Клиент</th>
                        <th onclick="sortTable(1)">Приход с площадки</th>
                        <th onclick="sortTable(2)">Траты на площадку</th>
                        <th onclick="sortTable(3)">Траты на звонки</th>
                        <th onclick="sortTable(4)">Траты на услуги</th>
                        <th onclick="sortTable(5)">Звонки с площадки</th>
                        <th onclick="sortTable(6)">Цена звонка</th>
                        <th onclick="sortTable(7)">Цена клиента</th>
                        <th onclick="sortTable(8)">Маржа</th>
                        <th onclick="sortTable(9)">Заработок</th>
                    </tr>
                </thead>
                <tbody>
                {% for stat in stats %}
                    <tr>
                        <td class="client-name">{{ stat.name }}</td>
                        <td>{{ stat.teleph_calls_sum|floatformat:"0" }}</td>
                        <td>{{ stat.platform|floatformat:"0" }}</td>
                        <td>{{ stat.calls_sum|floatformat:"0" }}</td>
                        <td>{{ stat.products_sum|floatformat:"0" }}</td>
                        <td>{{ stat.teleph_target }}</td>
                        <td>{{ stat.call_cost|floatformat:"0" }}</td>
                        <td>{{ stat.client_cost|floatformat:"0" }}</td>
                        {% if stat.margin < 0 %}
                            <td class="negative">{{ stat.margin|floatformat:"0" }}</td>
                        {% else %}
                            <td>{{ stat.margin|floatformat:"0" }}</td>
                        {% endif %}
                        {% if stat.profit < 0 %}
                            <td class="negative">{{ stat.profit|floatformat:"0" }}</td>
                        {% else %}
                            <td>{{ stat.profit|floatformat:"0" }}</td>
                        {% endif %}
                    </tr>
                {% endfor %}
                </tbody>
                <tfoot class="tfoot-dark">
                    <tr>
                        <td>Всего</td>
                        <td>{{ subtotal.teleph_calls_sum|floatformat:"0" }}</td>
                        <td>{{ subtotal.platform|floatformat:"0" }}</td>
                        <td>{{ subtotal.calls_sum|floatformat:"0" }}</td>
                        <td>{{ subtotal.products_sum|floatformat:"0" }}</td>
                        <td>{{ subtotal.teleph_target }}</td>
                        <td>{{ subtotal.calls_cost|floatformat:"0" }}</td>
                        <td>{{ subtotal.client_cost|floatformat:"0" }}</td>
                        {% if subtotal.margin < 0 %}
                            <td class="negative">{{ subtotal.margin|floatformat:"0" }}</td>
                        {% else %}
                            <td>{{ subtotal.margin|floatformat:"0" }}</td>
                        {% endif %}
                        {% if subtotal.profit < 0 %}
                            <td class="negative">{{ subtotal.profit|floatformat:"0" }}</td>
                        {% else %}
                            <td>{{ subtotal.profit|floatformat:"0" }}</td>
                        {% endif %}
                    </tr>
                </tfoot>
            </table>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}